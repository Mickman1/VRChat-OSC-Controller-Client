<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>VRChat OSC Controller</title>

	<link rel='stylesheet' href='style.css'>
	<script src='js/nipplejs.js'></script>
</head>

<body onblur='checkWebSocketConnection()' onfocus='checkWebSocketConnection()'>
	<div></div>
	<input type='text' id='messageBox' placeholder='Enter message'>
	<button id='sendBtn' onclick='sendChatboxMessage()'>Send!</button>
	
	<div id='joystick'></div>
	<div class='nipple'>
		<div class='front'></div>
		<div class='back'></div>
	</div>
</body>

	<script id='joystickInit'>
		var options = {
			zone: document.getElementById('joystick'),
			color: 'red',   
		}
		var manager = nipplejs.create(options)
		var inter
		manager.on('move', (evt, data) => {
			console.log(data.angle.degree)

			let degreeAdjusted = data.angle.degree

			if (degreeAdjusted < 110 && degreeAdjusted > 70) {
				ws.send(JSON.stringify({ message: 'keyDownForward', type: 'input', state: 'down' }))
				
				ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			}

			else if (degreeAdjusted < 290 && degreeAdjusted > 250) {
				ws.send(JSON.stringify({ message: 'keyDownBackward', type: 'input', state: 'down' }))
				
				ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			}

			else if (degreeAdjusted < 200 && degreeAdjusted > 160) {
				ws.send(JSON.stringify({ message: 'keyDownLeft', type: 'input', state: 'down' }))

				ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			}

			else if ((degreeAdjusted < 360 && degreeAdjusted > 340) || (degreeAdjusted < 20 && degreeAdjusted >= 0)) {
				ws.send(JSON.stringify({ message: 'keyDownRight', type: 'input', state: 'down' }))

				ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
			}

			else {
				ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
				ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			}
		})
		manager.on('end', (evt, data) => {
			ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
			ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
			ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
			ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			clearInterval(inter)
			console.log(data)
		})
	</script>

<script defer>
	const keyStates = {
		forward: false,
		backward: false,
		left: false,
		right: false,
		sprint: false,
		jump: false,
		crouch: false,
		prone: false,
		voice: false,
		lookLeft: false,
		lookRight: false,
	}
	
	const keyDownInputMap = {
		KeyW: 			{ input: 'keyDownForward', 		state: 'forward' },
		KeyS: 			{ input: 'keyDownBackward', 	state: 'backward' },
		KeyA: 			{ input: 'keyDownLeft', 			state: 'left'},
		KeyD: 			{ input: 'keyDownRight', 			state: 'right' },
		ShiftLeft: 	{ input: 'keyDownSprint', 		state: 'sprint' },
		Space: 			{ input: 'keyDownJump', 			state: 'jump' },
		KeyC: 			{ input: 'keyDownCrouch', 		state: 'crouch' },
		KeyZ: 			{ input: 'keyDownProne', 			state: 'prone' },
		KeyV: 			{ input: 'keyDownVoice', 			state: 'voice' },
		ArrowLeft: 	{ input: 'keyDownLookLeft', 	state: 'lookLeft' },
		ArrowRight: { input: 'keyDownLookRight', 	state: 'lookRight' },
	}
	
	const keyUpInputMap = {
		KeyW: 			{ input: 'keyUpForward', 			state: 'forward' },
		KeyS: 			{ input: 'keyUpBackward', 		state: 'backward' },
		KeyA: 			{ input: 'keyUpLeft', 				state: 'left' },
		KeyD: 			{ input: 'keyUpRight', 				state: 'right' },
		ShiftLeft: 	{ input: 'keyUpSprint', 			state: 'sprint' },
		Space: 			{ input: 'keyUpJump', 				state: 'jump' },
		KeyC: 			{ input: 'keyUpCrouch', 			state: 'crouch' },
		KeyZ: 			{ input: 'keyUpProne', 				state: 'prone' },
		KeyV: 			{ input: 'keyUpVoice', 				state: 'voice' },
		ArrowLeft: 	{ input: 'keyUpLookLeft', 		state: 'lookLeft' },
		ArrowRight: { input: 'keyUpLookRight', 		state: 'lookRight' },
	}

	var ws = new WebSocket('wss://mickbot.com/ws')

	document.getElementById('messageBox').addEventListener('keydown', function(event) {
		if (event.code === 'Enter') {
			sendChatboxMessage(event)
		}
	})

	document.addEventListener('keydown', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		if (keyDownInputMap[event.code] && keyStates[keyDownInputMap[event.code].state] === false) {
			let message = keyDownInputMap[event.code].input
			keyStates[keyDownInputMap[event.code].state] = true

			ws.send(JSON.stringify({ message: message, type: 'input', state: 'down' }))
		}
	})

	document.addEventListener('keyup', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		if (keyUpInputMap[event.code] && keyStates[keyUpInputMap[event.code].state] === true) {
			let message = keyUpInputMap[event.code].input
			keyStates[keyUpInputMap[event.code].state] = false
			
			ws.send(JSON.stringify({ message: message, type: 'input', state: 'up' }))
		}
	})

	function sendChatboxMessage() {
		if (document.getElementById('messageBox').value === '') 
			return;

		const message = document.getElementById('messageBox').value
		ws.send(JSON.stringify({ message: message, type: 'chatbox' }))

		document.getElementById('messageBox').value = ''
	}

	function checkWebSocketConnection() {
		if (ws.readyState !== WebSocket.OPEN) {
			ws = new WebSocket('wss://mickbot.com/ws')

			console.log('WebSocket was CLOSED, re-opening...')
		}
	}
</script>
</html>
