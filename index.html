<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>VRChat OSC Controller</title>

	<link rel='stylesheet' href='style.css'>
</head>

<body onblur='checkWebSocketConnection()' onfocus='checkWebSocketConnection()'>
	<div></div>
	<input type='text' id='messageBox' placeholder='Enter message'>
	<button id='sendBtn' onclick='sendChatboxMessage()'>Send!</button>
</body>

<script defer>
	const keyStates = {
		forward: false,
		backward: false,
		left: false,
		right: false,
		sprint: false,
		jump: false,
		crouch: false,
		prone: false,
		voice: false,
		lookLeft: false,
		lookRight: false,
	}

	var ws = new WebSocket('wss://mickbot.com/ws')

	document.getElementById('messageBox').addEventListener('keydown', function(event) {
		if (event.code === 'Enter') {
			sendChatboxMessage(event)
		}
	})

	document.addEventListener('keydown', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		let wsMessage = ''

		const inputMap = {
			KeyW: { message: 'keyDownForward', state: 'forward' },
			KeyS: { message: 'keyDownBackward', state: 'backward' },
			KeyA: { message: 'keyDownLeft', state: 'left' },
			KeyD: { message: 'keyDownRight', state: 'right' },
			ShiftLeft: { message: 'keyDownSprint', state: 'sprint' },
			Space: { message: 'keyDownJump', state: 'jump' },
			KeyC: { message: 'keyDownCrouch', state: 'crouch' },
			KeyZ: { message: 'keyDownProne', state: 'prone' },
			KeyV: { message: 'keyDownVoice', state: 'voice' },
			ArrowLeft: { message: 'keyDownLookLeft', state: 'lookLeft' },
			ArrowRight: { message: 'keyDownLookRight', state: 'lookRight' },
		};

		if (inputMap[event.code] && keyStates[inputMap[event.code].state] === false) {
			wsMessage = inputMap[event.code].message
			keyStates[inputMap[event.code].state] = true
		}
		else
			return;

		ws.send(JSON.stringify({ message: wsMessage, type: 'input' }))
	})

	document.addEventListener('keyup', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		const inputMap = {
			KeyW: { message: 'keyUpForward', state: 'forward' },
			KeyS: { message: 'keyUpBackward', state: 'backward' },
			KeyA: { message: 'keyUpLeft', state: 'left' },
			KeyD: { message: 'keyUpRight', state: 'right' },
			ShiftLeft: { message: 'keyUpSprint', state: 'sprint' },
			Space: { message: 'keyUpJump', state: 'jump' },
			KeyC: { message: 'keyUpCrouch', state: 'crouch' },
			KeyZ: { message: 'keyUpProne', state: 'prone' },
			KeyV: { message: 'keyUpVoice', state: 'voice' },
			ArrowLeft: { message: 'keyUpLookLeft', state: 'lookLeft' },
			ArrowRight: { message: 'keyUpLookRight', state: 'lookRight' },
		}

		if (inputMap[event.code]) {
			wsMessage = inputMap[event.code].message
			keyStates[inputMap[event.code].state] = false
		}
		else
			return;

		ws.send(JSON.stringify({ message: wsMessage, type: 'input' }))
	})

	function sendChatboxMessage() {
		if (document.getElementById('messageBox').value === '') 
			return;

		const message = document.getElementById('messageBox').value
		ws.send(JSON.stringify({ message: message, type: 'chatbox' }))

		document.getElementById('messageBox').value = ''
	}

	function checkWebSocketConnection() {
		if (ws.readyState !== WebSocket.OPEN) {
			ws = new WebSocket('wss://mickbot.com/ws')

			console.log('WebSocket was CLOSED, re-opening...')
		}
	}
</script>
</html>
