<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>VRChat OSC Controller</title>

	<link rel='stylesheet' href='style.css'>
	<script src='js/nipplejs.js'></script>
</head>

<body onblur='checkWebSocketConnection()' onfocus='checkWebSocketConnection()'>
	<div></div>
	<input type='text' id='message-box' placeholder='Enter message'>
	<button id='send-btn' onclick='sendChatboxMessage()'>Send</button>
	
	<div id='joystick-div'></div>
</body>

	<script id='joystick'>
		var options = {
			zone: document.getElementById('joystick-div'),
			color: 'red',   
		}
		var manager = nipplejs.create(options)
		manager.on('move', (evt, data) => {
			if (data.distance < 10) {
				ws.send(JSON.stringify({ message: 'keyUpAll', type: 'input', state: 'up' }))

				return;
			}

			if (data.distance > 40) {
				ws.send(JSON.stringify({ message: 'keyDownSprint', type: 'input', state: 'down' }))
			}
			else {
				ws.send(JSON.stringify({ message: 'keyUpSprint', type: 'input', state: 'up' }))
			}
			
			let degree = data.angle.degree

			if (degree < 145 && degree > 35) {
				keyStates.forward = true
				
				ws.send(JSON.stringify({ message: 'keyDownForward', type: 'input', state: 'down' }))
			}
			else
				keyStates.forward = false

			if (degree < 325 && degree > 215) {
				keyStates.backward = true
				
				ws.send(JSON.stringify({ message: 'keyDownBackward', type: 'input', state: 'down' }))
			}
			else
				keyStates.backward = false

			if (degree < 235 && degree > 125) {
				keyStates.left = true

				ws.send(JSON.stringify({ message: 'keyDownLeft', type: 'input', state: 'down' }))
			}
			else
				keyStates.left = false

			if ((degree < 360 && degree > 305) || (degree < 55 && degree >= 0)) {
				keyStates.right = true

				ws.send(JSON.stringify({ message: 'keyDownRight', type: 'input', state: 'down' }))
			}
			else
				keyStates.right = false

			if (!keyStates.forward) {
				ws.send(JSON.stringify({ message: 'keyUpForward', type: 'input', state: 'up' }))
			}
			if (!keyStates.backward) {
				ws.send(JSON.stringify({ message: 'keyUpBackward', type: 'input', state: 'up' }))
			}
			if (!keyStates.left) {
				ws.send(JSON.stringify({ message: 'keyUpLeft', type: 'input', state: 'up' }))
			}
			if (!keyStates.right) {
				ws.send(JSON.stringify({ message: 'keyUpRight', type: 'input', state: 'up' }))
			}
		})
		manager.on('end', (evt, data) => {
			ws.send(JSON.stringify({ message: 'keyUpAll', type: 'input', state: 'up' }))

			keyStates.forward = false
			keyStates.backward = false
			keyStates.left = false
			keyStates.right = false
		})
	</script>

<script defer>
	const keyStates = {
		forward: false,
		backward: false,
		left: false,
		right: false,
		sprint: false,
		jump: false,
		crouch: false,
		prone: false,
		voice: false,
		lookLeft: false,
		lookRight: false,
	}
	
	const keyDownInputMap = {
		KeyW: 			{ input: 'keyDownForward', 		state: 'forward' },
		KeyS: 			{ input: 'keyDownBackward', 	state: 'backward' },
		KeyA: 			{ input: 'keyDownLeft', 			state: 'left'},
		KeyD: 			{ input: 'keyDownRight', 			state: 'right' },
		ShiftLeft: 	{ input: 'keyDownSprint', 		state: 'sprint' },
		Space: 			{ input: 'keyDownJump', 			state: 'jump' },
		KeyC: 			{ input: 'keyDownCrouch', 		state: 'crouch' },
		KeyZ: 			{ input: 'keyDownProne', 			state: 'prone' },
		KeyV: 			{ input: 'keyDownVoice', 			state: 'voice' },
		ArrowLeft: 	{ input: 'keyDownLookLeft', 	state: 'lookLeft' },
		ArrowRight: { input: 'keyDownLookRight', 	state: 'lookRight' },
	}
	
	const keyUpInputMap = {
		KeyW: 			{ input: 'keyUpForward', 			state: 'forward' },
		KeyS: 			{ input: 'keyUpBackward', 		state: 'backward' },
		KeyA: 			{ input: 'keyUpLeft', 				state: 'left' },
		KeyD: 			{ input: 'keyUpRight', 				state: 'right' },
		ShiftLeft: 	{ input: 'keyUpSprint', 			state: 'sprint' },
		Space: 			{ input: 'keyUpJump', 				state: 'jump' },
		KeyC: 			{ input: 'keyUpCrouch', 			state: 'crouch' },
		KeyZ: 			{ input: 'keyUpProne', 				state: 'prone' },
		KeyV: 			{ input: 'keyUpVoice', 				state: 'voice' },
		ArrowLeft: 	{ input: 'keyUpLookLeft', 		state: 'lookLeft' },
		ArrowRight: { input: 'keyUpLookRight', 		state: 'lookRight' },
	}

	var ws = new WebSocket('wss://mickbot.com/ws')

	document.getElementById('message-box').addEventListener('keydown', function(event) {
		if (event.code === 'Enter') {
			sendChatboxMessage(event)
		}
	})

	document.addEventListener('keydown', function(event) {
		if (document.activeElement === document.getElementById('message-box'))
			return;

		if (keyDownInputMap[event.code] && keyStates[keyDownInputMap[event.code].state] === false) {
			let message = keyDownInputMap[event.code].input
			keyStates[keyDownInputMap[event.code].state] = true

			ws.send(JSON.stringify({ message: message, type: 'input', state: 'down' }))
		}
	})

	document.addEventListener('keyup', function(event) {
		if (document.activeElement === document.getElementById('message-box'))
			return;

		if (keyUpInputMap[event.code] && keyStates[keyUpInputMap[event.code].state] === true) {
			let message = keyUpInputMap[event.code].input
			keyStates[keyUpInputMap[event.code].state] = false
			
			ws.send(JSON.stringify({ message: message, type: 'input', state: 'up' }))
		}
	})

	function sendChatboxMessage() {
		if (document.getElementById('message-box').value === '') 
			return;

		const message = document.getElementById('message-box').value
		ws.send(JSON.stringify({ message: message, type: 'chatbox' }))

		document.getElementById('message-box').value = ''
	}

	function checkWebSocketConnection() {
		if (ws.readyState !== WebSocket.OPEN) {
			ws = new WebSocket('wss://mickbot.com/ws')

			console.log('WebSocket was CLOSED, re-opening...')
		}
	}
</script>
</html>
