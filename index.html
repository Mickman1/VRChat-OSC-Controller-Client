<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>VRChat OSC Controller</title>

	<link rel='stylesheet' href='style.css'>
</head>

<body onblur='checkWebSocketConnection()' onfocus='checkWebSocketConnection()'>
	<div></div>
	<input type='text' id='messageBox' placeholder='Enter message'>
	<button id='sendBtn' onclick='sendChatboxMessage()'>Send!</button>
</body>

<script defer>
	const keyStates = {
		forward: false,
		backward: false,
		left: false,
		right: false,
		sprint: false,
		jump: false,
		crouch: false,
		prone: false,
		voice: false,
		lookLeft: false,
		lookRight: false,
	}

	var ws = new WebSocket('wss://mickbot.com/ws')

	document.getElementById('messageBox').addEventListener('keydown', function(event) {
		if (event.code === 'Enter') {
			sendChatboxMessage(event)
		}
	})

	document.addEventListener('keydown', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		let wsMessage = ''

		switch(event.code) {
			case 'KeyW':
				if (!keyStates.forward) {
					wsMessage = 'keyDownForward'
					keyStates.forward = true
				}
				break
			case 'KeyS':
				if (!keyStates.backward) {
					wsMessage = 'keyDownBackward'
					keyStates.backward = true
				}
				break
			case 'KeyA':
				if (!keyStates.left) {
					wsMessage = 'keyDownLeft'
					keyStates.left = true
				}
				break
			case 'KeyD':
				if (!keyStates.right) {
					wsMessage = 'keyDownRight'
					keyStates.right = true
				}
				break
			case 'ShiftLeft':
				if (!keyStates.sprint) {
					wsMessage = 'keyDownSprint'
					keyStates.sprint = true
				}
				break
			case 'Space':
				if (!keyStates.jump) {
					wsMessage = 'keyDownJump'
					keyStates.jump = true
				}
				break
			case 'KeyC':
				if (!keyStates.crouch) {
					wsMessage = 'keyDownCrouch'
					keyStates.crouch = true
				}
				break
			case 'KeyZ':
				if (!keyStates.prone) {
					wsMessage = 'keyDownProne'
					keyStates.prone = true
				}
				break
			default:
				return;
		}

		if (wsMessage === '')
			return;

		ws.send(JSON.stringify({ message: wsMessage, type: 'input' }))
		console.log(1)
	})

	document.addEventListener('keyup', function(event) {
		if (document.activeElement === document.getElementById('messageBox'))
			return;

		let wsMessage = ''

		switch(event.code) {
			case 'KeyW':
				wsMessage = 'keyUpForward'
				keyStates.forward = false
				break
			case 'KeyS':
				wsMessage = 'keyUpBackward'
				keyStates.backward = false
				break
			case 'KeyA':
				wsMessage = 'keyUpLeft'
				keyStates.left = false
				break
			case 'KeyD':
				wsMessage = 'keyUpRight'
				keyStates.right = false
				break
			case 'ShiftLeft':
				wsMessage = 'keyUpSprint'
				keyStates.sprint = false
				break
			case 'Space':
				wsMessage = 'keyUpJump'
				keyStates.jump = false
				break
			case 'KeyC':
				wsMessage = 'keyUpCrouch'
				keyStates.crouch = false
				break
			case 'KeyZ':
				wsMessage = 'keyUpProne'
				keyStates.prone = false
				break
			default:
				return;
		}

		if (wsMessage === '')
			return;

		ws.send(JSON.stringify({ message: wsMessage, type: 'input' }))
	})

	function sendChatboxMessage() {
		if (document.getElementById('messageBox').value === '') 
			return;

		const message = document.getElementById('messageBox').value
		ws.send(JSON.stringify({ message: message, type: 'chatbox' }))

		document.getElementById('messageBox').value = ''
	}

	function keydown(key) {
		ws.send(key)
	}

	function forward() {
		ws.send('forward')
	}
	function backward() {
		ws.send('backward')
	}
	function left() {
		ws.send('left')
	}
	function right() {
		ws.send('right')
	}

	function checkWebSocketConnection() {
		if (ws.readyState !== WebSocket.OPEN) {
			ws = new WebSocket('wss://mickbot.com/ws')

			console.log('WebSocket was CLOSED, re-opening...')
		}
	}
</script>
</html>
